name: Shopify Theme Deploy

on:
  push:
    branches:
      - staging
      - main
    paths:
      - assets/**
      - config/**
      - layout/**
      - locales/**
      - sections/**
      - snippets/**
      - templates/**
      - .github/workflows/shopify-theme-deploy.yml
  workflow_dispatch:
    inputs:
      target:
        description: "Destino de despliegue"
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read

concurrency:
  group: shopify-theme-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-staging:
    name: Deploy Staging Theme
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/staging') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'staging')
    runs-on: ubuntu-latest
    env:
      SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
      SHOPIFY_FLAG_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_CLI_TTY: "0"
      STAGING_THEME_ID: ${{ secrets.SHOPIFY_THEME_ID_STAGING }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Shopify CLI
        run: npm install --global @shopify/cli@latest @shopify/theme@latest

      - name: Normalize store domain
        run: |
          normalized="${SHOPIFY_FLAG_STORE#https://}"
          normalized="${normalized#http://}"
          normalized="${normalized%%/*}"
          echo "SHOPIFY_FLAG_STORE=$normalized" >> "$GITHUB_ENV"

      - name: Validate required secrets
        run: |
          test -n "$SHOPIFY_CLI_THEME_TOKEN" || (echo "Missing SHOPIFY_CLI_THEME_TOKEN" && exit 1)
          test -n "$SHOPIFY_FLAG_STORE" || (echo "Missing SHOPIFY_STORE" && exit 1)
          test -n "$STAGING_THEME_ID" || (echo "Missing SHOPIFY_THEME_ID_STAGING" && exit 1)
          if ! [[ "$STAGING_THEME_ID" =~ ^[0-9]+$ ]]; then
            echo "SHOPIFY_THEME_ID_STAGING must be numeric"
            exit 1
          fi

      - name: Push theme to staging
        run: shopify theme push --path . --store "$SHOPIFY_FLAG_STORE" --theme "$STAGING_THEME_ID" --nodelete

  deploy-production:
    name: Deploy Production Theme
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'production')
    runs-on: ubuntu-latest
    env:
      SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
      SHOPIFY_FLAG_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_CLI_TTY: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Shopify CLI
        run: npm install --global @shopify/cli@latest @shopify/theme@latest

      - name: Normalize store domain
        run: |
          normalized="${SHOPIFY_FLAG_STORE#https://}"
          normalized="${normalized#http://}"
          normalized="${normalized%%/*}"
          echo "SHOPIFY_FLAG_STORE=$normalized" >> "$GITHUB_ENV"

      - name: Validate required secrets
        run: |
          test -n "$SHOPIFY_CLI_THEME_TOKEN" || (echo "Missing SHOPIFY_CLI_THEME_TOKEN" && exit 1)
          test -n "$SHOPIFY_FLAG_STORE" || (echo "Missing SHOPIFY_STORE" && exit 1)

      - name: Push theme to production
        run: shopify theme push --path . --store "$SHOPIFY_FLAG_STORE" --live --nodelete --allow-live
